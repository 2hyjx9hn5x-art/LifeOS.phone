<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Life OS V9.1 - Ultimate Fixed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ============================
           V9.1 æ ¸å¿ƒè§†è§‰ç³»ç»Ÿ (è«å…°è¿ªç´«)
           ============================ */
        :root {
            --bg-gradient: linear-gradient(135deg, #fcfafa 0%, #eae1e6 100%);
            --primary-color: #856f86; --accent-color: #af98b4;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --border-color: rgba(133, 111, 134, 0.15);
            --text-main: #5e525e; --text-sub: #9e949e;
            --accent-soft: rgba(175, 152, 180, 0.15);
            --p1-color: #b57b82; --p2-color: #cfa87a; --p3-color: #8ea0b3; --p0-color: #dcd6da;
            --success-color: #94a89a; --danger-bg: rgba(181, 123, 130, 0.1);
            --radius: 16px;
            --tab-height: 90px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-gradient); color: var(--text-main); 
            height: 100%; min-height: 100vh;
            overflow-y: auto; /* å…³é”®ä¿®å¤ï¼šå…è®¸é¡µé¢æ»šåŠ¨ */
            padding-bottom: 120px; /* é˜²æ­¢å†…å®¹è¢«åº•éƒ¨å¯¼èˆªé®æŒ¡ */
        }

        /* ============================
           é€šç”¨ç»„ä»¶
           ============================ */
        .input-wrapper-v9 { 
            background: #fff; border: 1px solid #f0edf0; border-radius: 16px; 
            padding: 15px; display: flex; flex-direction: column; gap: 12px; 
            box-shadow: 0 8px 30px rgba(133, 111, 134, 0.08); 
        }
        
        .main-input { border: none; background: transparent; font-size: 16px; width: 100%; height: 40px; color: #333; }
        .main-input::placeholder { color: #ccc; }

        .tool-btn { 
            width: 36px; height: 36px; border-radius: 10px; display: flex; 
            justify-content: center; align-items: center; color: #bab0ba; background: #f9f6f9; transition: 0.2s;
        }
        .tool-btn.active-red { background: var(--danger-bg); color: var(--p1-color); border: 1px solid var(--p1-color); }
        .tool-btn.active-purple { background: var(--accent-soft); color: var(--accent-color); border: 1px solid var(--accent-color); }

        .link-goal-btn {
            font-size: 12px; color: #999; background: #f5f5f7; padding: 4px 10px; border-radius: 6px; display: flex; align-items: center; gap: 5px; cursor: pointer;
        }
        .link-goal-btn.active { color: var(--primary-color); background: var(--accent-soft); font-weight: 700; }

        .check-circle { width: 22px; height: 22px; border: 2px solid #dcd0dc; border-radius: 50%; margin-right: 12px; position: relative; flex-shrink: 0; }
        .check-circle.checked { background: var(--success-color); border-color: var(--success-color); }
        .check-circle.checked::after { content: 'âœ“'; color: #fff; position: absolute; left: 5px; top: 0px; font-size: 12px; }
        
        .priority-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .ddl-tag { font-size: 10px; background: var(--danger-bg); color: var(--p1-color); padding: 2px 5px; border-radius: 4px; margin-left: 5px; }

        /* ============================
           å¸ƒå±€ä¸å¯¼èˆª
           ============================ */
        /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª */
        .mobile-bottom-nav {
            display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: var(--tab-height);
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.05); z-index: 9000;
            padding-bottom: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.02);
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #bab0ba; font-size: 10px; gap: 4px; transition: 0.2s; }
        .nav-item.active { color: var(--primary-color); font-weight: 700; }
        .nav-item.active i { color: var(--accent-color); transform: translateY(-3px); }

        /* é¡µé¢å®¹å™¨ */
        .page-container { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page-container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* æ ‡é¢˜å¤´ */
        .header-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 25px; padding-top: 10px; }
        .big-title { font-size: 28px; font-weight: 800; color: var(--primary-color); }
        .sub-title { font-size: 12px; color: #999; margin-top: 5px; letter-spacing: 1px; }

        /* ============================
           æ¨¡å—æ ·å¼
           ============================ */
        /* ç›®æ ‡å¡ç‰‡ */
        .category-block { margin-bottom: 25px; }
        .category-header { display: flex; justify-content: space-between; font-size: 14px; font-weight: 700; color: var(--text-main); margin-bottom: 12px; align-items: center; }
        .goal-card { 
            background: #fff; padding: 18px; border-radius: 14px; margin-bottom: 12px; 
            box-shadow: 0 4px 15px rgba(133,111,134,0.04); position: relative; overflow: hidden;
        }
        .goal-card .progress-bar { height: 5px; background: #f0f0f0; border-radius: 3px; margin-top: 12px; overflow: hidden; }
        .goal-card .progress-fill { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.5s; }

        /* æ—¥å† */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; background: #fff; padding: 15px; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); }
        .day-cell { 
            background: #fff; border-radius: 10px; min-height: 85px; padding: 6px; 
            display: flex; flex-direction: column; border: 1px solid #f9f9f9;
        }
        .day-cell.today { border: 1.5px solid var(--accent-color); background: #fcfafa; }
        .day-num { font-size: 14px; font-weight: 700; color: #bab0ba; margin-bottom: 4px; text-align: center; }
        .task-dot { font-size: 9px; background: rgba(133,111,134,0.08); color: #666; padding: 2px 4px; border-radius: 4px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-item { 
            background: #fff; padding: 16px; border-radius: 14px; margin-bottom: 12px; 
            display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border: 1px solid #fcfcfc;
        }

        /* å¼¹çª— */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); z-index: 9999; 
            display: none; justify-content: center; align-items: center; 
        }
        .modal-window { 
            width: 90%; max-width: 450px; max-height: 85vh; background: #fff; 
            border-radius: 20px; box-shadow: 0 20px 60px rgba(133,111,134,0.15); 
            display: flex; flex-direction: column; overflow: hidden; border: 1px solid #f0edf0;
        }
        .modal-header { padding: 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 18px; color: var(--primary-color); }
        .modal-body { padding: 20px; overflow-y: auto; }
        
        /* æ‰¹é‡ç”Ÿæˆå™¨ - æ—¥æœŸèŒƒå›´ä¿®å¤ */
        .date-range-row { display: flex; gap: 10px; margin-top: 10px; }
        .date-input { flex: 1; padding: 8px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 12px; color: #666; background: #fafafa; }
        
        .week-selector { display: flex; justify-content: space-between; margin: 10px 0; }
        .week-btn { width: 34px; height: 34px; border-radius: 50%; background: #fff; border: 1px solid #eee; display: flex; justify-content: center; align-items: center; font-size: 12px; color: #999; transition: 0.2s; }
        .week-btn.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); box-shadow: 0 3px 8px rgba(175, 152, 180, 0.3); }

        /* Toast */
        .toast { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 12px; z-index: 10000; opacity: 0; pointer-events: none; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; top: 60px; }
    </style>
</head>
<body>

    <nav class="mobile-bottom-nav">
        <div class="nav-item active" onclick="switchTab(1)">
            <i class="fas fa-chart-pie" style="font-size: 20px;"></i> æ¦‚è§ˆ
        </div>
        <div class="nav-item" onclick="switchTab(2)">
            <i class="fas fa-calendar-check" style="font-size: 20px;"></i> ä»Šæ—¥
        </div>
        <div class="nav-item" onclick="switchTab(3)">
            <i class="fas fa-inbox" style="font-size: 20px;"></i> å¾…åŠ
        </div>
    </nav>

    <div class="toast" id="toastMsg">æ¶ˆæ¯æç¤º</div>

    <div class="page-container active" id="page1">
        <div class="header-row">
            <div>
                <div class="big-title">Life OS</div>
                <div class="sub-title">THINK BIG, START SMALL.</div>
            </div>
            <div onclick="openBackupModal()" style="padding:10px; background:#fff; border-radius:50%; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
                <i class="fas fa-database" style="color:var(--primary-color);"></i>
            </div>
        </div>

        <div id="categoryContainer"></div>
        <button class="add-btn-dashed" onclick="promptCategory()">+ æ–°å¢åˆ†åŒº (Add Category)</button>

        <div style="margin-top:30px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <span style="font-size:18px; font-weight:700; color:var(--primary-color);">Calendar</span>
                <div style="font-size:14px; color:#999;">
                    <span id="calYearMonth">2025-12</span>
                    <i class="fas fa-chevron-left" style="padding:5px 10px; margin-left:10px;" onclick="changeMonth(-1)"></i>
                    <i class="fas fa-chevron-right" style="padding:5px 10px;" onclick="changeMonth(1)"></i>
                </div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <div class="page-container" id="page2">
        <div class="header-row">
            <div>
                <div class="big-title">Today</div>
                <div class="sub-title" id="todayDateDisplay">2025-12-04</div>
            </div>
        </div>

        <div id="todayTaskList" style="min-height:100px; margin-bottom:30px;"></div>
        
        <div class="input-wrapper-v9">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="link-goal-btn" id="linkGoalBtn" onclick="openLinkSelector('today')">
                    <i class="fas fa-link"></i> å…³è”ç›®æ ‡
                </div>
                
                <select id="taskPriority" style="border:none; background:transparent; font-size:12px; color:#666; text-align:right;">
                    <option value="0">é»˜è®¤ P0</option>
                    <option value="1">é«˜ä¼˜ P1</option>
                    <option value="2">ä¸­ä¼˜ P2</option>
                </select>
            </div>
            
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="tool-btn" onclick="toggleDDLInput('taskDDL', this)"><i class="far fa-clock"></i></div>
                <input type="time" id="taskDDL" style="display:none; border:1px solid #eee; border-radius:6px; font-size:12px; padding:5px;">
                
                <div class="tool-btn" onclick="toggleBtnState(this)" id="btnInboxMode"><i class="fas fa-inbox"></i></div>
                
                <input type="text" id="todayInput" class="main-input" placeholder="æ·»åŠ ä»Šæ—¥ä»»åŠ¡..." onkeypress="handleEnter(event, 'today')">
                <button onclick="addTodayTask()" style="width:40px; height:40px; background:var(--primary-color); border:none; border-radius:12px; color:#fff; box-shadow:0 4px 10px rgba(133,111,134,0.3);"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <textarea id="todayMemo" style="width:100%; height:100px; margin-top:20px; padding:15px; border:none; background:#fff; border-radius:16px; font-family:inherit; font-size:13px; box-shadow:0 5px 20px rgba(0,0,0,0.02);" placeholder="ğŸ“ å†™ç‚¹æ¯æ—¥æ„Ÿæ‚Ÿ..." onblur="saveMemo()"></textarea>
    </div>

    <div class="page-container" id="page3">
        <div class="header-row">
            <div>
                <div class="big-title">Inbox</div>
                <div class="sub-title">CAPTURE EVERYTHING</div>
            </div>
        </div>

        <div class="input-wrapper-v9" style="margin-bottom:30px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="link-goal-btn" id="inboxLinkGoalBtn" onclick="openLinkSelector('inbox')">
                    <i class="fas fa-link"></i> å…³è”ç›®æ ‡ (å¯é€‰)
                </div>
                <select id="inboxPriority" style="border:none; background:transparent; font-size:12px; color:#666;">
                    <option value="0">é»˜è®¤ P0</option>
                    <option value="1">é«˜ä¼˜ P1</option>
                    <option value="2">ä¸­ä¼˜ P2</option>
                </select>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="tool-btn" onclick="toggleDDLInput('inboxDDL', this)"><i class="far fa-clock"></i></div>
                <input type="datetime-local" id="inboxDDL" style="display:none; border:1px solid #eee; border-radius:6px; font-size:12px; padding:5px; width:120px;">
                
                <input type="text" id="inboxInput" class="main-input" placeholder="æœ‰ä»€ä¹ˆæƒ³æ³•ï¼Ÿ" onkeypress="handleEnter(event, 'inbox')">
                <button onclick="addInboxTaskFull()" style="width:40px; height:40px; background:var(--primary-color); border:none; border-radius:12px; color:#fff;"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div id="inboxList"></div>
    </div>

    <div class="modal-overlay" id="goalSelectorModal">
        <div class="modal-window" style="height:auto;">
            <div class="modal-header">
                <span>é€‰æ‹©å…³è”ç›®æ ‡</span>
                <i class="fas fa-times" onclick="document.getElementById('goalSelectorModal').style.display='none'"></i>
            </div>
            <div class="modal-body" id="goalSelectorList"></div>
        </div>
    </div>

    <div class="modal-overlay" id="goalModalOverlay">
        <div class="modal-window">
            <div class="modal-header">
                <span id="goalModalTitle">è¯¦æƒ…</span>
                <i class="fas fa-times" onclick="closeGoalModal()" style="color:#ccc;"></i>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:#999; margin-bottom:5px;">
                        <span>è¿›åº¦</span> <span id="goalPercent" style="color:var(--accent-color); font-weight:700;">0%</span>
                    </div>
                    <div style="height:6px; background:#f0f0f0; border-radius:3px; overflow:hidden;">
                        <div id="goalBar" style="height:100%; width:0%; background:var(--accent-color);"></div>
                    </div>
                </div>

                <div style="max-height:150px; overflow-y:auto; border-bottom:1px solid #f0f0f0; margin-bottom:20px;">
                    <div id="goalTaskList"></div>
                </div>

                <div class="batch-form" style="background:#f9f9fc; padding:15px; border-radius:12px;">
                    <h4 style="font-size:13px; color:var(--primary-color); margin-bottom:10px;">âš¡ æ‰¹é‡ç”Ÿæˆå™¨</h4>
                    <input type="text" id="batchName" placeholder="ä»»åŠ¡åç§°" style="width:100%; padding:8px; border:1px solid #e0e0e0; border-radius:6px; font-size:12px; margin-bottom:10px;">
                    
                    <div style="display:flex; gap:10px; margin-bottom:10px; font-size:12px;">
                        <span onclick="setBatchMode('periodic')" id="tabPeriodic" style="color:var(--accent-color); font-weight:700; cursor:pointer;">æŒ‰å‘¨å¾ªç¯</span>
                        <span style="color:#ddd;">|</span>
                        <span onclick="setBatchMode('free')" id="tabFree" style="color:#999; cursor:pointer;">æ—¥å†ç‚¹é€‰</span>
                    </div>

                    <div id="modePeriodic">
                        <div class="week-selector">
                            <div class="week-btn" onclick="toggleWeek(this,1)">ä¸€</div>
                            <div class="week-btn" onclick="toggleWeek(this,2)">äºŒ</div>
                            <div class="week-btn" onclick="toggleWeek(this,3)">ä¸‰</div>
                            <div class="week-btn" onclick="toggleWeek(this,4)">å››</div>
                            <div class="week-btn" onclick="toggleWeek(this,5)">äº”</div>
                            <div class="week-btn" onclick="toggleWeek(this,6)">å…­</div>
                            <div class="week-btn" onclick="toggleWeek(this,0)">æ—¥</div>
                        </div>
                        <div class="date-range-row">
                            <input type="date" id="batchStartDate" class="date-input" placeholder="å¼€å§‹">
                            <input type="date" id="batchEndDate" class="date-input" placeholder="ç»“æŸ">
                        </div>
                    </div>

                    <div id="modeFree" style="display:none;">
                        <div class="calendar-grid" id="miniCalGrid" style="grid-template-columns: repeat(7, 1fr); gap:4px; padding:0; box-shadow:none;"></div>
                    </div>

                    <button onclick="runBatchGenerate()" style="width:100%; background:var(--primary-color); color:#fff; border:none; padding:10px; border-radius:8px; font-size:12px; margin-top:10px;">ç«‹å³ç”Ÿæˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="backupModal">
        <div class="modal-window" style="height:auto;">
            <div class="modal-header">
                <span>ğŸ“¦ æ•°æ®å®‰å…¨</span>
                <i class="fas fa-times" onclick="document.getElementById('backupModal').style.display='none'"></i>
            </div>
            <div class="modal-body">
                <textarea id="backupText" style="width:100%; height:100px; padding:10px; border:1px solid #eee; font-size:12px;" placeholder="ç‚¹å‡»ä¸‹æ–¹å¤åˆ¶..."></textarea>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="copyData()" style="flex:1; padding:10px; background:#f0f0f0; border:none; border-radius:8px;">å¤åˆ¶</button>
                    <button onclick="importData()" style="flex:1; padding:10px; background:var(--p1-color); color:#fff; border:none; border-radius:8px;">å¯¼å…¥æ¢å¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DB_KEY = 'life_os_v9_1_ultimate';
        let store = { categories: [{id:1, name:'å·¥ä½œ'}, {id:2, name:'ç”Ÿæ´»'}], goals:[], tasks:[], config:{} };
        let viewYear = new Date().getFullYear(), viewMonth = new Date().getMonth();
        let activeGoalId = null;
        let tempLinkGoalId = null; // ä¸´æ—¶å­˜å‚¨å…³è”çš„ç›®æ ‡ID
        let linkSource = 'today'; // 'today' or 'inbox'
        
        let batchMode = 'periodic';
        let batchDays = [];
        let batchDates = [];

        window.onload = function() {
            if(localStorage.getItem(DB_KEY)) try { store = JSON.parse(localStorage.getItem(DB_KEY)); } catch(e){}
            refreshUI();
            document.getElementById('todayDateDisplay').innerText = new Date().toISOString().split('T')[0];
            if(window.innerWidth <= 768) switchTab(1);
        };

        function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(store)); refreshUI(); }
        function refreshUI() { renderSidebar(); renderCalendar(); renderToday(); renderInbox(); }

        // ================= é¦–é¡µ =================
        function renderSidebar() {
            const c = document.getElementById('categoryContainer'); c.innerHTML = '';
            store.categories.forEach(cat => {
                const goals = store.goals.filter(g => g.catId === cat.id);
                let html = `<div class="category-block">
                    <div class="category-header">
                        <span>${cat.name}</span>
                        <div style="display:flex; gap:15px;">
                            <i class="fas fa-plus" onclick="promptGoal(${cat.id})" style="color:var(--accent-color);"></i>
                            <i class="fas fa-trash" onclick="deleteCategory(${cat.id})" style="color:#ddd; font-size:12px;"></i>
                        </div>
                    </div>`;
                goals.forEach(g => {
                    const total = store.tasks.filter(t => t.linkGoalId === g.id).length;
                    const done = store.tasks.filter(t => t.linkGoalId === g.id && t.done).length;
                    const pct = total ? (done/total)*100 : 0;
                    html += `<div class="goal-card" onclick="openGoalModal(${g.id})">
                        <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:5px;">
                            <span>${g.title}</span> 
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span style="font-size:12px; color:#bab0ba;">${done}/${total}</span>
                                <i class="fas fa-trash" style="font-size:10px; color:#f0f0f0;" onclick="event.stopPropagation(); deleteGoal(${g.id})"></i>
                            </div>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                    </div>`;
                });
                html += `</div>`;
                c.innerHTML += html;
            });
        }

        function renderCalendar() {
            document.getElementById('calYearMonth').innerText = `${viewYear}-${viewMonth+1}`;
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            const days = new Date(viewYear, viewMonth+1, 0).getDate();
            const start = new Date(viewYear, viewMonth, 1).getDay();
            const today = new Date().toISOString().split('T')[0];

            for(let i=0; i<start; i++) grid.innerHTML += '<div></div>';
            for(let d=1; d<=days; d++) {
                const dateStr = `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const tasks = store.tasks.filter(t => t.date === dateStr && !t.isMemo);
                let dots = tasks.slice(0,3).map(t => `<div class="task-dot" style="${t.done?'text-decoration:line-through;color:#ccc':''}">${t.text}</div>`).join('');
                if(tasks.length>3) dots += `<div style="font-size:9px; color:#ccc; text-align:center;">+${tasks.length-3}</div>`;
                
                grid.innerHTML += `<div class="day-cell ${dateStr===today?'today':''}" onclick="openDateDetail('${dateStr}')">
                    <div class="day-num" style="color:${dateStr===today?'var(--accent-color)':'#bab0ba'}">${d}</div>
                    <div style="flex:1; overflow:hidden;">${dots}</div>
                </div>`;
            }
        }
        function changeMonth(n) { viewMonth+=n; if(viewMonth>11){viewMonth=0;viewYear++} if(viewMonth<0){viewMonth=11;viewYear--} refreshUI(); }

        // ================= ä»Šæ—¥ & è¾“å…¥ä¿®å¤ =================
        function renderToday() {
            const list = document.getElementById('todayTaskList'); list.innerHTML = '';
            const dateStr = new Date().toISOString().split('T')[0];
            const tasks = store.tasks.filter(t => t.date === dateStr && !t.isMemo);
            
            if(tasks.length===0) list.innerHTML = `<div style="text-align:center; color:#ddd; margin-top:50px;">Today is a blank canvas.</div>`;
            
            tasks.forEach(t => list.innerHTML += createTaskHTML(t));
            
            const memo = store.tasks.find(t => t.date === dateStr && t.isMemo);
            document.getElementById('todayMemo').value = memo ? memo.text : '';
        }

        function addTodayTask() {
            const txt = document.getElementById('todayInput').value.trim();
            if(!txt) return;
            const isInbox = document.getElementById('btnInboxMode').classList.contains('active-purple');
            store.tasks.push({
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                text: txt,
                done: false,
                priority: document.getElementById('taskPriority').value,
                ddl: document.getElementById('taskDDL').value || null,
                inInbox: isInbox,
                linkGoalId: tempLinkGoalId // ä½¿ç”¨å…³è”çš„ç›®æ ‡ID
            });
            resetInput('today'); saveData();
        }

        // ================= å¾…åŠ & å…¨åŠŸèƒ½è¾“å…¥ =================
        function renderInbox() {
            const list = document.getElementById('inboxList'); list.innerHTML = '';
            const tasks = store.tasks.filter(t => t.inInbox && !t.done);
            if(tasks.length===0) list.innerHTML = '<div style="text-align:center; color:#ddd; margin-top:50px;">Inbox Zero! ğŸ‰</div>';
            tasks.forEach(t => list.innerHTML += createTaskHTML(t));
        }

        function addInboxTaskFull() {
            const txt = document.getElementById('inboxInput').value.trim();
            if(!txt) return;
            store.tasks.push({
                id: Date.now(),
                text: txt,
                date: '', // å¾…åŠé»˜è®¤æ— æ—¥æœŸ
                done: false,
                inInbox: true,
                priority: document.getElementById('inboxPriority').value,
                ddl: document.getElementById('inboxDDL').value || null,
                linkGoalId: tempLinkGoalId
            });
            resetInput('inbox'); saveData();
        }

        // ================= è¾…åŠ©é€»è¾‘ =================
        function createTaskHTML(t) {
            let ddlHtml = t.ddl ? `<span class="ddl-tag">${t.ddl.replace('T', ' ')}</span>` : '';
            let pColor = t.priority==1 ? 'var(--p1-color)' : (t.priority==2 ? 'var(--p2-color)' : '#ddd');
            let goalName = '';
            if(t.linkGoalId) {
                const g = store.goals.find(x=>x.id===t.linkGoalId);
                if(g) goalName = `<span style="font-size:10px; color:var(--accent-color); background:var(--accent-soft); padding:2px 5px; border-radius:4px; margin-left:5px;">#${g.title}</span>`;
            }

            return `<div class="task-item">
                <div class="check-circle ${t.done?'checked':''}" onclick="toggleTask(${t.id})"></div>
                <div style="flex:1;">
                    <div style="font-size:14px; color:${t.done?'#ccc':'#333'}; text-decoration:${t.done?'line-through':''}">${t.text}</div>
                    <div style="font-size:11px; margin-top:3px; display:flex; align-items:center;">
                        <span class="priority-dot" style="background:${pColor}"></span> 
                        ${ddlHtml} ${goalName}
                    </div>
                </div>
                <i class="fas fa-trash" style="color:#eee; padding:10px;" onclick="deleteTask(${t.id})"></i>
            </div>`;
        }

        function toggleTask(id) { const t=store.tasks.find(x=>x.id===id); if(t){t.done=!t.done; saveData();} }
        function deleteTask(id) { if(confirm('åˆ é™¤æ­¤ä»»åŠ¡?')) { store.tasks=store.tasks.filter(x=>x.id!==id); saveData(); } }
        function deleteCategory(id) { if(confirm('åˆ é™¤æ­¤åˆ†åŒºåŠå…¶ä¸‹æ‰€æœ‰ç›®æ ‡?')) { store.categories=store.categories.filter(x=>x.id!==id); store.goals=store.goals.filter(x=>x.catId!==id); saveData(); } }
        function deleteGoal(id) { if(confirm('åˆ é™¤æ­¤ç›®æ ‡?')) { store.goals=store.goals.filter(x=>x.id!==id); saveData(); } }

        // ç›®æ ‡é€‰æ‹©å™¨é€»è¾‘
        function openLinkSelector(source) {
            linkSource = source;
            const list = document.getElementById('goalSelectorList'); list.innerHTML = '<div onclick="selectGoal(null)" style="padding:10px; border-bottom:1px solid #eee;">ğŸš« ä¸å…³è”</div>';
            store.goals.forEach(g => {
                list.innerHTML += `<div onclick="selectGoal(${g.id}, '${g.title}')" style="padding:10px; border-bottom:1px solid #eee;">ğŸ¯ ${g.title}</div>`;
            });
            document.getElementById('goalSelectorModal').style.display = 'flex';
        }
        function selectGoal(id, title) {
            tempLinkGoalId = id;
            document.getElementById('goalSelectorModal').style.display = 'none';
            const btnId = linkSource === 'today' ? 'linkGoalBtn' : 'inboxLinkGoalBtn';
            const btn = document.getElementById(btnId);
            if(id) {
                btn.innerHTML = `<i class="fas fa-link"></i> ${title}`;
                btn.classList.add('active');
            } else {
                btn.innerHTML = `<i class="fas fa-link"></i> å…³è”ç›®æ ‡`;
                btn.classList.remove('active');
            }
        }

        function resetInput(source) {
            if(source==='today') {
                document.getElementById('todayInput').value='';
                selectGoal(null); // é‡ç½®å…³è”
            } else {
                document.getElementById('inboxInput').value='';
                selectGoal(null);
            }
        }

        // ================= æ‰¹é‡ç”Ÿæˆ (ä¿®å¤ç‰ˆ) =================
        function openGoalModal(gid) {
            activeGoalId = gid;
            const g = store.goals.find(x => x.id === gid);
            document.getElementById('goalModalTitle').innerText = g.title;
            
            // åˆ—è¡¨
            const list = document.getElementById('goalTaskList'); list.innerHTML = '';
            store.tasks.filter(t => t.linkGoalId === gid).forEach(t => {
                list.innerHTML += `<div style="font-size:12px; border-bottom:1px solid #eee; padding:8px 0; color:#666;">
                   ${t.date||'æ— æ—¥æœŸ'} - ${t.text} <span style="float:right">${t.done?'âœ…':''}</span>
                </div>`;
            });
            
            renderMiniCal();
            document.getElementById('goalModalOverlay').style.display = 'flex';
        }

        function runBatchGenerate() {
            const name = document.getElementById('batchName').value;
            if(!name) { showToast('è¯·è¾“å…¥ä»»åŠ¡å'); return; }
            
            let targets = [];
            if(batchMode === 'periodic') {
                const s = document.getElementById('batchStartDate').value;
                const e = document.getElementById('batchEndDate').value;
                if(!s || !e || batchDays.length===0) { showToast('è¯·å®Œå–„æ—¥æœŸå’Œæ˜ŸæœŸè®¾ç½®'); return; }
                
                let curr = new Date(s);
                const end = new Date(e);
                while(curr <= end) {
                    if(batchDays.includes(curr.getDay())) {
                        targets.push(curr.toISOString().split('T')[0]);
                    }
                    curr.setDate(curr.getDate()+1);
                }
            } else {
                targets = batchDates;
            }
            
            if(targets.length===0) { showToast('æœªç”Ÿæˆä»»ä½•æ—¥æœŸ'); return; }
            
            targets.forEach((date, i) => {
                store.tasks.push({id:Date.now()+i, date:date, text:name, linkGoalId:activeGoalId, done:false, priority:0});
            });
            
            showToast(`å·²ç”Ÿæˆ ${targets.length} ä¸ªä»»åŠ¡`);
            saveData(); document.getElementById('goalModalOverlay').style.display = 'none';
        }

        // UI Helpers
        function switchTab(id) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item')[id-1].classList.add('active');
            document.querySelectorAll('.page-container').forEach(el => el.classList.remove('active'));
            document.getElementById('page'+id).classList.add('active');
        }
        function toggleDDLInput(id, btn) { 
            const el = document.getElementById(id); 
            el.style.display = el.style.display==='none'?'block':'none'; 
            btn.classList.toggle('active-red');
        }
        function toggleBtnState(btn) { btn.classList.toggle('active-purple'); }
        function handleEnter(e, src) { if(e.key==='Enter') src==='today'?addTodayTask():addInboxTaskFull(); }
        function saveMemo() {
             const d = new Date().toISOString().split('T')[0];
             const txt = document.getElementById('todayMemo').value;
             store.tasks = store.tasks.filter(t => !(t.date === d && t.isMemo));
             if(txt.trim()) store.tasks.push({id:Date.now(), date:d, text:txt, isMemo:true});
             saveData();
        }
        function promptCategory() { const n=prompt('åˆ†åŒºåç§°:'); if(n) { store.categories.push({id:Date.now(), name:n}); saveData(); } }
        function promptGoal(cid) { const n=prompt('ç›®æ ‡åç§°:'); if(n) { store.goals.push({id:Date.now(), catId:cid, title:n}); saveData(); } }
        
        // Batch Helpers
        function setBatchMode(m) {
            batchMode = m;
            document.getElementById('modePeriodic').style.display = m==='periodic'?'block':'none';
            document.getElementById('modeFree').style.display = m==='free'?'block':'none';
            document.getElementById('tabPeriodic').style.color = m==='periodic'?'var(--accent-color)':'#999';
            document.getElementById('tabFree').style.color = m==='free'?'var(--accent-color)':'#999';
        }
        function toggleWeek(btn, d) {
            btn.classList.toggle('active');
            if(batchDays.includes(d)) batchDays = batchDays.filter(x=>x!==d); else batchDays.push(d);
        }
        function renderMiniCal() {
            const grid = document.getElementById('miniCalGrid'); grid.innerHTML = '';
            const days = new Date(viewYear, viewMonth+1, 0).getDate();
            for(let d=1; d<=days; d++) {
                const div = document.createElement('div'); div.className='week-btn'; div.innerText=d; div.style.borderRadius='4px';
                div.onclick = function() {
                    this.classList.toggle('active');
                    const dateStr = `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    if(batchDates.includes(dateStr)) batchDates = batchDates.filter(x=>x!==dateStr); else batchDates.push(dateStr);
                };
                grid.appendChild(div);
            }
        }
        function closeGoalModal() { document.getElementById('goalModalOverlay').style.display = 'none'; }
        
        // Backup
        function openBackupModal() { document.getElementById('backupModal').style.display='flex'; document.getElementById('backupText').value = JSON.stringify(store); }
        function copyData() { document.getElementById('backupText').select(); document.execCommand('copy'); showToast('å·²å¤åˆ¶'); }
        function importData() { try{ const d=JSON.parse(document.getElementById('backupText').value); if(d.tasks){ store=d; saveData(); location.reload(); } }catch(e){ showToast('æ ¼å¼é”™è¯¯'); } }
        function showToast(m) { const t=document.getElementById('toastMsg'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
        function openDateDetail(date) { 
             // ç®€å•å¤„ç†ï¼šå¦‚æœç‚¹å‡»ä»Šå¤©ï¼Œè·³Todayï¼›å¦åˆ™æç¤ºã€‚æœªæ¥å¯åšå…¨å±æ—¥è¯¦æƒ…ã€‚
             if(date === new Date().toISOString().split('T')[0]) switchTab(2);
             else showToast(`æŸ¥çœ‹ ${date} (åŠŸèƒ½å¼€å‘ä¸­)`);
        }
    </script>
</body>
</html>
